import { useContext, useEffect, useState } from 'react'
import AddPlayerForm from './forms/AddPlayerForm'
import { CombatContext, CombatContextProps } from '../../lib/contexts/CombatContext';
import Button from './Btn';
import { Reorder } from "framer-motion"

export default function PartyList({ className } : { className?: string } ) {
    const combatContext = useContext(CombatContext)

    if (!combatContext) {
        throw new Error('useCombatContext must be used within a contextProvider');
    }

    const { players, setPlayers } = combatContext as CombatContextProps
    const [initiative, setInitiative] = useState<number[]>([0,1,2,3,4,5,6,7,8]);

    const handleDissmisPlayer = (i: number) => {
        if (players.length > 0) {
            let newPlayers = [...players]
            newPlayers.splice(i, 1)
            setPlayers(newPlayers)
        }
    }

    const handleHp = (e: React.ChangeEvent<HTMLInputElement>, i: number) => {
        const { value } = e.target
        let currentHp = value
        if (players.length > 0) {
            let newPlayers = [...players]
            newPlayers[i].hp = currentHp
            setPlayers(newPlayers)
        }
    }

    const handleTurn = (i: number) => {
        if (players.length > 0) {
            let newTurn = [...players]
            newTurn[i].turn = !newTurn[i].turn
            newTurn.forEach((player, index) => {
                if (index !== i) {
                    player.turn = false
                }
            })
            newTurn.unshift(newTurn.splice(i, 1)[0])
            setPlayers(newTurn)
        }
    }
  
  return (
    <div className={ className + ' flex flex-col gap-2 border-b border-amber-950'}>
        <h2 className="text-xl font-semibold border-b border-amber-950 pb-3 mb-2">Grupo</h2>
        <AddPlayerForm/>
        <Reorder.Group 
        axis='y'
        values={initiative}
        onReorder={setInitiative}
        className="flex flex-col"
        >
            {
                players.map((player, i) => 
                <Reorder.Item
                key={initiative[i]}
                value={initiative[i]}
                className="flex items-center"
                >
                    <div className="flex items-center gap-2 p-2 text-start cursor-pointer rounded-md hover:bg-amber-200/50">
                        <p className="sm:w-[82px] text-lg font-bold truncate border-b border-amber-950">{player.name}</p>
                        <p className="font-medium">HP:
                            <input 
                            type="text" 
                            value={ player.hp }
                            min='0'
                            max='999'
                            onChange={ (e) => handleHp(e, i) }
                            className="w-[46px] px-2 ms-1"
                            />
                        </p>
                        {
                            player.turn ?
                            <button 
                            className='bg-none rounded-md'
                            onClick={() => handleTurn(i)}
                            >
                                <svg fill="#d97706" width="24px" height="24px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <path d="m198.6 601.4c-5.457-5.457-8.5195-12.855-8.5195-20.566 0-7.7148 3.0625-15.113 8.5195-20.566l61.699-61.699-41.133-41.133c-7.3477-7.3477-10.219-18.059-7.5312-28.094 2.6914-10.039 10.531-17.875 20.566-20.566 10.039-2.6875 20.746 0.17969 28.094 7.5273l123.4 123.39c7.3477 7.3477 10.219 18.059 7.5273 28.094-2.6875 10.039-10.527 17.879-20.562 20.57-10.039 2.6875-20.75-0.17969-28.098-7.5273l-41.129-41.137-61.703 61.703c-5.4531 5.4531-12.852 8.5156-20.562 8.5156-7.7148 0-15.113-3.0625-20.566-8.5156zm390.33-411.32h-52.574c-5.5703 0-10.906 2.2109-14.844 6.1484l-210.96 210.96 82.262 82.27 210.97-210.97v-0.003906c3.9336-3.9375 6.1406-9.2734 6.1406-14.836v-52.578c0-5.5664-2.2109-10.906-6.1484-14.844s-9.2734-6.1484-14.844-6.1484zm-49.223 308.49 41.133-41.133c7.3477-7.3477 10.215-18.059 7.5273-28.094-2.6914-10.039-10.531-17.875-20.566-20.566-10.039-2.6875-20.746 0.17969-28.094 7.5273l-123.4 123.39c-7.3477 7.3477-10.219 18.059-7.5273 28.094 2.6875 10.039 10.527 17.879 20.566 20.57 10.035 2.6875 20.746-0.17969 28.094-7.5273l41.133-41.133 61.699 61.699c7.3477 7.3477 18.055 10.215 28.094 7.5273 10.035-2.6914 17.875-10.531 20.566-20.566 2.6875-10.039-0.17969-20.746-7.5273-28.094zm-276.05-308.49h-52.578c-5.5664 0-10.906 2.2109-14.844 6.1484s-6.1484 9.2773-6.1484 14.844v52.578c0 5.5664 2.2109 10.906 6.1484 14.844l91.832 91.828 82.262-82.27-91.832-91.824c-3.9336-3.9375-9.2734-6.1484-14.84-6.1484z"/>
                                </svg>
                            </button>
                            :
                            <button 
                            className='bg-none rounded-md'
                            onClick={() => handleTurn(i)}
                            >
                                <svg fill="#fbbf24" width="24px" height="24px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <path d="m198.6 601.4c-5.457-5.457-8.5195-12.855-8.5195-20.566 0-7.7148 3.0625-15.113 8.5195-20.566l61.699-61.699-41.133-41.133c-7.3477-7.3477-10.219-18.059-7.5312-28.094 2.6914-10.039 10.531-17.875 20.566-20.566 10.039-2.6875 20.746 0.17969 28.094 7.5273l123.4 123.39c7.3477 7.3477 10.219 18.059 7.5273 28.094-2.6875 10.039-10.527 17.879-20.562 20.57-10.039 2.6875-20.75-0.17969-28.098-7.5273l-41.129-41.137-61.703 61.703c-5.4531 5.4531-12.852 8.5156-20.562 8.5156-7.7148 0-15.113-3.0625-20.566-8.5156zm390.33-411.32h-52.574c-5.5703 0-10.906 2.2109-14.844 6.1484l-210.96 210.96 82.262 82.27 210.97-210.97v-0.003906c3.9336-3.9375 6.1406-9.2734 6.1406-14.836v-52.578c0-5.5664-2.2109-10.906-6.1484-14.844s-9.2734-6.1484-14.844-6.1484zm-49.223 308.49 41.133-41.133c7.3477-7.3477 10.215-18.059 7.5273-28.094-2.6914-10.039-10.531-17.875-20.566-20.566-10.039-2.6875-20.746 0.17969-28.094 7.5273l-123.4 123.39c-7.3477 7.3477-10.219 18.059-7.5273 28.094 2.6875 10.039 10.527 17.879 20.566 20.57 10.035 2.6875 20.746-0.17969 28.094-7.5273l41.133-41.133 61.699 61.699c7.3477 7.3477 18.055 10.215 28.094 7.5273 10.035-2.6914 17.875-10.531 20.566-20.566 2.6875-10.039-0.17969-20.746-7.5273-28.094zm-276.05-308.49h-52.578c-5.5664 0-10.906 2.2109-14.844 6.1484s-6.1484 9.2773-6.1484 14.844v52.578c0 5.5664 2.2109 10.906 6.1484 14.844l91.832 91.828 82.262-82.27-91.832-91.824c-3.9336-3.9375-9.2734-6.1484-14.84-6.1484z"/>
                                </svg>
                            </button>
                        }
                        <button 
                        className='bg-none rounded-md'
                        onClick={() => console.log('buffitos')}
                        >
                            <svg fill="#155e75" width="24px" height="24px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg">
                                <path d="m382.9 172.81c20.797 120.39 25.586 299.11 4.7383 460.21-64.883-24.656-111.77-93.156-137.37-176.95-1.2891-4.1875-0.76953-8.707 1.418-12.484 2.1719-3.7773 5.8398-6.4883 10.094-7.4609 16.281-3.7617 28.008-18.625 28.008-36.133 0-20.797-16.5-37.785-37.141-38.559l-6.2656 1.2734c-4.3125 0.86719-8.8008-0.10938-12.359-2.6914-3.5742-2.582-5.8867-6.5352-6.4062-10.91-4.8008-40.918 0.34766-84.355 16.262-120.74 2.3789-5.4336 7.5898-9.0547 13.508-9.3984 58.945-3.4336 92.449-18.406 125.51-46.16zm31.738-1.2266c35.457 26.496 70.172 42.398 128.41 47.422 5.7461 0.48828 10.77 4.0938 13.082 9.3828 16.516 37.895 20.516 79.555 16.199 120.43-0.82031 7.7461-7.1797 13.699-14.91 14.059l-0.73828 0.03125c-1.793 0-3.5586-0.31641-5.2109-0.89844l-3.3203-0.56641c-20.734 0.62891-37.375 17.664-37.375 38.559 0 17.602 11.855 32.543 28.277 36.18 4.2656 0.94531 7.9492 3.6211 10.172 7.3828 2.2031 3.7773 2.7539 8.2812 1.5117 12.469-24.027 80.812-68.488 147.35-130.93 173.69 19.996-160.89 15.176-336.97-5.1641-458.14z" fill-rule="evenodd"/>
                            </svg>
                        </button>
                        <button 
                        className='bg-none rounded-md'
                        onClick={() => console.log('debuffitos')}
                        >
                            <svg fill="#3f3f46" width="24px" height="24px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg">
                                <g>
                                    <path d="m413.7 527.21 95.172 95.172c20.277 20.277 49.832 28.195 77.535 20.773 27.699-7.4219 49.332-29.055 56.754-56.754 7.4219-27.703-0.49609-57.258-20.773-77.535l-95.172-95.172c-12.496-12.422-28.738-20.383-46.215-22.645-17.473-2.2617-35.207 1.2969-50.453 10.129l-31.488-31.488c8.832-15.246 12.391-32.98 10.129-50.457-2.2617-17.473-10.223-33.715-22.645-46.211l-95.41-95.41c-20.277-20.277-49.832-28.195-77.531-20.773-27.699 7.4219-49.336 29.059-56.758 56.758-7.4219 27.699 0.49609 57.254 20.773 77.531l95.172 95.172c12.496 12.426 28.738 20.383 46.215 22.645 17.473 2.2656 35.207-1.2969 50.453-10.129l31.488 31.488c-8.8594 15.297-12.414 33.098-10.105 50.621 2.3047 17.527 10.344 33.801 22.859 46.285zm84.23-84.23 95.172 95.172c9.8438 9.8438 13.688 24.191 10.086 37.637-3.6016 13.445-14.105 23.949-27.551 27.551-13.445 3.6055-27.793-0.23828-37.637-10.082l-95.016-95.332c-9.3867-9.4258-13.281-23.008-10.312-35.973l14.562 14.953c5.3008 5.3047 13.027 7.375 20.27 5.4336s12.898-7.5977 14.84-14.84-0.12891-14.969-5.4336-20.27l-14.879-14.879h0.003906c12.996-2.8594 26.551 1.1523 35.895 10.629zm-195.86-85.965-95.172-95.172c-9.8438-9.8438-13.688-24.191-10.086-37.637 3.6016-13.445 14.105-23.949 27.551-27.551 13.449-3.6055 27.797 0.24219 37.637 10.086l95.016 95.328c9.3906 9.4258 13.281 23.008 10.312 35.977l-14.562-14.957c-5.3008-5.3008-13.027-7.3711-20.27-5.4336-7.2422 1.9414-12.898 7.5977-14.84 14.84-1.9375 7.2422 0.13281 14.969 5.4336 20.27l14.879 14.879c-13 2.8594-26.555-1.1523-35.898-10.629z"/>
                                    <path d="m576.65 223.35c-2.8359-2.8477-6.6914-4.4453-10.707-4.4453-4.0195 0-7.8711 1.5977-10.707 4.4453l-52.035 52.035v-0.003907c-3.8242 3.8281-5.3164 9.4023-3.918 14.625 1.4023 5.2266 5.4805 9.3086 10.707 10.707 5.2266 1.3984 10.801-0.09375 14.625-3.918l52.035-52.035c2.8438-2.8359 4.4453-6.6875 4.4453-10.707 0-4.0156-1.6016-7.8672-4.4453-10.703z"/>
                                    <path d="m536.73 389.84c2.8398 2.8398 6.6914 4.4258 10.707 4.4062h73.523c5.4023 0 10.391-2.8789 13.09-7.5547 2.6992-4.6758 2.6992-10.438 0-15.113-2.6992-4.6797-7.6875-7.5586-13.09-7.5586h-73.523c-4.0156-0.011719-7.8711 1.5781-10.715 4.4141-2.8398 2.8398-4.4375 6.6875-4.4375 10.707 0.003907 4.0156 1.6016 7.8633 4.4453 10.699z"/>
                                    <path d="m405.75 252.55c0 5.4023 2.8789 10.391 7.5547 13.09 4.6797 2.6992 10.438 2.6992 15.117 0 4.6758-2.6992 7.5547-7.6875 7.5547-13.09v-73.602c0-5.4023-2.8789-10.391-7.5547-13.09-4.6797-2.6992-10.438-2.6992-15.117 0-4.6758 2.6992-7.5547 7.6875-7.5547 13.09z"/>
                                    <path d="m296.72 503.28c-2.8359-2.8477-6.6914-4.4453-10.707-4.4453-4.0195 0-7.8711 1.5977-10.707 4.4453l-51.953 52.031c-3.8242 3.8242-5.3203 9.4023-3.918 14.625 1.3984 5.2266 5.4805 9.3047 10.703 10.707 5.2266 1.3984 10.801-0.09375 14.625-3.918l52.035-52.035c2.8359-2.8477 4.4219-6.7031 4.4062-10.723-0.015625-4.0156-1.6289-7.8633-4.4844-10.688z"/>
                                    <path d="m263.26 410.15c-2.8359-2.8398-6.6914-4.4258-10.707-4.4062h-73.602c-5.4023 0-10.391 2.8789-13.09 7.5547-2.6992 4.6797-2.6992 10.438 0 15.117 2.6992 4.6758 7.6875 7.5547 13.09 7.5547h73.523c4.0156 0.011719 7.8711-1.5781 10.715-4.4141 2.8398-2.8359 4.4375-6.6875 4.4375-10.703-0.003906-4.0156-1.6016-7.8672-4.4453-10.703z"/>
                                    <path d="m394.25 547.44c0-5.3984-2.8789-10.391-7.5547-13.09-4.6758-2.6992-10.438-2.6992-15.113 0-4.6797 2.6992-7.5586 7.6914-7.5586 13.09v73.523c0 5.4023 2.8789 10.391 7.5586 13.09 4.6758 2.6992 10.438 2.6992 15.113 0 4.6758-2.6992 7.5547-7.6875 7.5547-13.09z"/>
                                </g>
                            </svg>
                        </button>
                        <Button click={()=> handleDissmisPlayer(i)} className='w-auto ms-auto'>
                            <svg fill="#fffbeb" width="16px" height="16px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg">
                                <path d="m552.51 305.07v281.79c0 29.668-24.273 53.957-53.957 53.957h-197.12c-29.668 0-53.957-24.273-53.957-53.957v-281.79zm-208.62-145.88h112.23c17.41 0 31.648 14.254 31.648 31.648v25.543h91.004v65.461h-357.53v-65.461h91.004v-25.543c0-17.41 14.254-31.648 31.648-31.648zm-14.328 262.45c-4.5352-4.5352-4.5352-11.895 0-16.43 4.5352-4.5352 11.895-4.5352 16.43 0l54.02 54.02 54.02-54.02c4.5352-4.5352 11.895-4.5352 16.43 0 4.5352 4.5352 4.5352 11.895 0 16.43l-54.02 54.02 54.02 54.02c4.5352 4.5352 4.5352 11.895 0 16.43-4.5352 4.5352-11.895 4.5352-16.43 0l-54.02-54.02-54.02 54.02c-4.5352 4.5352-11.895 4.5352-16.43 0-4.5352-4.5352-4.5352-11.895 0-16.43l54.02-54.02z" fill-rule="evenodd"/>
                            </svg>
                        </Button>
                    </div>
                </Reorder.Item>
                )
            }
        </Reorder.Group> 
    </div>
  )
}
